class StockHoldings{constructor(){this.apiKey="cshj6s1r01qu99bg0oe0cshj6s1r01qu99bg0oeg",this.isFetching=!1,this.fetchRetryTimeout=null,this.chartData=[],this.myChart=null,this.sectorData=[],this.sectorChart=null,this.isDarkMode=!1,this.sectorColors={Semiconductors:"#007bff","Internet/Cloud":"#17a2b8",Software:"#6f42c1",Hardware:"#495057","AI/ML":"#8b5cf6",Cybersecurity:"#dc3545",Gaming:"#ff6b35","Social Media":"#ffc107",Healthcare:"#28a745",Biotechnology:"#20c997",Pharmaceuticals:"#198754","Medical Devices":"#0dcaf0","Healthcare Services":"#10b981",Fintech:"#f59e0b",Banking:"#f97316",Insurance:"#06b6d4","Investment Banking":"#6c757d","Real Estate":"#84cc16",REITs:"#0ea5e9","Consumer Discretionary":"#f59e0b","Consumer Staples":"#ea580c",Retail:"#e11d48","E-commerce":"#7c3aed","Food & Beverage":"#059669",Apparel:"#be185d",Industrial:"#64748b",Manufacturing:"#475569",Aerospace:"#0284c7",Defense:"#991b1b",Automotive:"#c2410c",Transportation:"#0891b2",Energy:"#eab308","Oil & Gas":"#d97706","Renewable Energy":"#16a34a",Materials:"#78716c",Mining:"#57534e",Chemicals:"#14b8a6","Communication Services":"#8b5cf6",Media:"#a855f7",Entertainment:"#c084fc",Telecommunications:"#7c2d12",Utilities:"#0d9488","Utilities/Energy":"#14b8a6",ETF:"#6366f1","Index Fund":"#374151","Mutual Fund":"#4b5563",Crypto:"#f59e0b",Blockchain:"#ea580c",Unknown:"#9ca3af",Diversified:"#6b7280"},this.darkThemeColorMap={"#007bff":"#60a5fa","#17a2b8":"#22d3ee","#6f42c1":"#a78bfa","#495057":"#9ca3af","#8b5cf6":"#c084fc","#dc3545":"#f87171","#ff6b35":"#fb7185","#ffc107":"#fbbf24","#28a745":"#4ade80","#20c997":"#2dd4bf","#198754":"#22c55e","#0dcaf0":"#38bdf8","#10b981":"#34d399","#f59e0b":"#fbbf24","#f97316":"#fb923c","#06b6d4":"#38bdf8","#6c757d":"#9ca3af","#84cc16":"#a3e635","#0ea5e9":"#0ea5e9","#64748b":"#94a3b8","#475569":"#64748b","#0284c7":"#0ea5e9","#991b1b":"#dc2626","#c2410c":"#ea580c","#0891b2":"#0891b2","#eab308":"#facc15","#d97706":"#f59e0b","#16a34a":"#22c55e","#78716c":"#a8a29e","#57534e":"#78716c","#14b8a6":"#2dd4bf","#a855f7":"#c084fc","#c084fc":"#ddd6fe","#7c2d12":"#a16207","#0d9488":"#14b8a6","#14b8a6":"#2dd4bf","#6366f1":"#818cf8","#374151":"#6b7280","#4b5563":"#9ca3af","#ea580c":"#f97316","#9ca3af":"#d1d5db","#6b7280":"#9ca3af"},this.init()}init(){document.addEventListener("DOMContentLoaded",()=>{this.detectTheme(),this.setupEventListeners(),this.generateSectorCSS(),this.initializeCharts(),this.loadStocksData()})}detectTheme(){this.isDarkMode="dark"===document.documentElement.getAttribute("data-theme")}initializeCharts(){this.initChart()}loadStocksData(){this.fetchDataAndUpdate()}generateSectorCSS(){const e="dynamic-sector-styles";let t=document.getElementById(e);t&&t.remove();const a=document.createElement("style");a.id=e;let o="\n      /* \u52a8\u6001\u751f\u6210\u7684\u884c\u4e1a\u6837\u5f0f - \u7b80\u6d01\u98ce\u683c */\n      .sector-tag {\n        font-weight: 500;\n        padding: 3px 8px;\n        border-radius: 4px;\n        font-size: 0.78em;\n        display: inline-block;\n        border: none;\n        white-space: nowrap;\n        letter-spacing: 0.2px;\n      }\n    ";Object.entries(this.sectorColors).forEach(([e,t])=>{const a=this.generateCSSClassName(e),i=this.hexToRgb(t),r=this.getDarkThemeColor(t);o+=`\n        .sector-${a} {\n          color: ${t};\n          background-color: rgba(${i.r}, ${i.g}, ${i.b}, 0.1);\n        }\n      `;const s=this.hexToRgb(r);o+=`\n        [data-theme='dark'] .sector-${a} {\n          color: ${r};\n          background-color: rgba(${s.r}, ${s.g}, ${s.b}, 0.18);\n        }\n      `}),o+='\n      .sector-tag:not([class*="sector-"]) {\n        color: #6b7280;\n        background-color: rgba(107, 114, 128, 0.08);\n      }\n      \n      [data-theme=\'dark\'] .sector-tag:not([class*="sector-"]) {\n        color: #9ca3af;\n        background-color: rgba(156, 163, 175, 0.15);\n      }\n    ',a.textContent=o,document.head.appendChild(a)}generateCSSClassName(e){return e.toLowerCase().replace(/[\s\/&]+/g,"-").replace(/[^a-z0-9-]/g,"").replace(/-+/g,"-").replace(/^-|-$/g,"")}hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:107,g:114,b:128}}getDarkThemeColor(e){return this.darkThemeColorMap[e]||e}getCurrentPSTTime(){const e=new Date,t={timeZone:"America/Los_Angeles",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1};return new Intl.DateTimeFormat("en-US",t).format(e)}showFetchingIndicator(e,t="info"){const a=document.getElementById("fetching-indicator");a.innerText=e,a.classList.remove("success","error"),"success"===t?a.classList.add("success"):"error"===t&&a.classList.add("error"),a.style.display="block"}hideFetchingIndicator(){document.getElementById("fetching-indicator").style.display="none"}showError(e){this.showFetchingIndicator(e,"error")}showSuccess(e){this.showFetchingIndicator(e,"success")}async fetchCurrentPrice(e){const t=`https://finnhub.io/api/v1/quote?symbol=${"BTC"===e.symbol?"BINANCE:BTCUSDT":e.symbol}&token=${this.apiKey}`;let a=0;const o=5,i=300;for(;a<=o;)try{const r=await fetch(t);if(429===r.status){if(a++,a>o)throw new Error(`Rate limit exceeded for ${e.symbol} after ${o} retries`);const t=i*Math.pow(2,a)+100*Math.random();console.log(`Rate limited for ${e.symbol}, retrying after ${t.toFixed(0)}ms (retry ${a}/${o})`),await new Promise(e=>setTimeout(e,t));continue}const s=await r.json();if(s.c)return void(e.curr_price=s.c);throw console.error(`No data for symbol: ${e.symbol}`),e.curr_price=0,new Error(`No data for symbol: ${e.symbol}`)}catch(t){if(a++,a>o||t.message.includes("No data for symbol"))throw console.error(`Error fetching data for ${e.symbol}:`,t),e.curr_price=0,t;const r=i*Math.pow(2,a)+100*Math.random();console.log(`Error for ${e.symbol}, retrying after ${r.toFixed(0)}ms (retry ${a}/${o})`),await new Promise(e=>setTimeout(e,r))}}async fetchAllPrices(e){const t=3;for(let a=0;a<e.length;a+=t){const o=e.slice(a,a+t).map(e=>this.fetchCurrentPrice(e));await Promise.all(o).catch(e=>console.error("Batch error:",e)),a+t<e.length&&await new Promise(e=>setTimeout(e,500))}}calculateStocks(e){e.forEach(e=>{e.stock=`${e.name}`,e.curr_price=parseFloat(e.curr_price.toFixed(2)),e.cost_price=parseFloat(e.cost_price.toFixed(2)),e.value=parseFloat((e.qty*e.curr_price).toFixed(2)),e.cost_basis=parseFloat((e.qty*e.cost_price).toFixed(2)),e.pl_dollar=parseFloat((e.value-e.cost_basis).toFixed(2)),e.pl_percent=parseFloat((e.pl_dollar/e.cost_basis*100).toFixed(2)),e.pl_class=e.pl_percent>=0?"pl-positive":"pl-negative"})}createEmojiIndicator(e){const t=e.performance_type,a=Math.abs(Math.round(e.pl_percent)),o="positive"===t?"+":"-",i=e.pl_percent;let r;return r="positive"===t?i>=50?"\ud83e\udd29":i>=30?"\ud83d\ude0d":i>=20?"\ud83d\ude01":i>=10?"\ud83d\ude04":i>=5?"\ud83d\ude0a":i>=1?"\ud83d\ude42":"\ud83d\ude10":i<=-50?"\ud83d\ude2d":i<=-30?"\ud83d\ude22":i<=-20?"\ud83d\ude30":i<=-10?"\ud83d\ude1e":i<=-5?"\ud83d\ude15":i<=-1?"\ud83d\ude1f":"\ud83d\ude10",`<div class="emoji-indicator">\n              <div class="performance-emoji">${r}</div>\n              <div class="emoji-value emoji-value-${t}">${o}${a}%</div>\n            </div>`}initChart(){var e=document.getElementById("portfolioChart");this.myChart=echarts.init(e);var t=document.getElementById("sectorChart");this.sectorChart=echarts.init(t),this.setChartTheme();new MutationObserver(()=>this.setChartTheme()).observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]})}setChartTheme(){const e="dark"===document.documentElement.getAttribute("data-theme");this.myChart.setOption(this.getChartOptions(e)),this.sectorChart.setOption(this.getSectorChartOptions(e))}getChartOptions(e){return{title:{text:"Portfolio Breakdown by Stock Value",left:"center",top:"5%",textStyle:{fontFamily:'"EB Garamond", serif',fontSize:18,fontWeight:"bold",color:e?"#ffffff":"#000000"}},color:["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc","#6b778d","#b5bd48","#e44a8c","#4e9caa","#8c7853","#a1488e","#5d7148","#e77c30","#4682b4","#bc8f8f","#6a5acd"],tooltip:{trigger:"item",formatter:function(e){return`${e.data.fullName}: ${e.percent}%`},textStyle:{fontFamily:'"EB Garamond", serif',color:e?"#ffffff":"#000000"},backgroundColor:e?"#333333":"#ffffff",borderColor:e?"#ffffff":"#333333"},legend:{orient:"vertical",right:"2%",top:"middle",itemGap:12,itemWidth:14,itemHeight:14,textStyle:{fontFamily:'"EB Garamond", serif',fontSize:13,color:e?"#ffffff":"#000000",padding:[0,0,0,8]},formatter:e=>{const t=this.chartData.find(t=>t.symbol===e);return t?t.name:e}},series:[{name:"Stock Value",type:"pie",radius:["40%","65%"],center:["35%","55%"],avoidLabelOverlap:!0,itemStyle:{borderRadius:10,borderColor:e?"#333333":"#ffffff",borderWidth:2},label:{show:!0,formatter:"{b}: {d}%",fontFamily:'"EB Garamond", serif',fontSize:13,position:"outside",distanceToLabelLine:20,color:e?"#ffffff":"#000000"},labelLine:{show:!0,lineStyle:{color:e?"#ffffff":"#333333"},length:25,length2:20},labelLayout:{moveOverlap:"shiftY"},emphasis:{scale:!0,scaleSize:10}}]}}getSectorChartOptions(e){return{title:{text:"Portfolio Breakdown by Sector",left:"center",top:"5%",textStyle:{fontFamily:'"EB Garamond", serif',fontSize:18,fontWeight:"bold",color:e?"#ffffff":"#000000"}},tooltip:{trigger:"item",formatter:function(e){return`${e.name}: ${e.percent}% (${e.data.count} holdings)`},textStyle:{fontFamily:'"EB Garamond", serif',color:e?"#ffffff":"#000000"},backgroundColor:e?"#333333":"#ffffff",borderColor:e?"#ffffff":"#333333"},legend:{orient:"vertical",right:"5%",top:"middle",itemGap:12,textStyle:{fontFamily:'"EB Garamond", serif',fontSize:14,color:e?"#ffffff":"#000000"}},series:[{name:"Sector Distribution",type:"pie",radius:["30%","60%"],center:["40%","55%"],avoidLabelOverlap:!0,itemStyle:{borderRadius:8,borderColor:e?"#333333":"#ffffff",borderWidth:2},label:{show:!0,formatter:"{b}: {d}%",fontFamily:'"EB Garamond", serif',fontSize:13,color:e?"#ffffff":"#000000"},emphasis:{scale:!0,scaleSize:10},data:this.sectorData||[]}]}}updateChart(e){this.chartData=e.map(e=>({name:e.name,symbol:e.symbol,value:e.value})),this.myChart.setOption({series:[{data:this.chartData.map(e=>({name:e.symbol,value:e.value,fullName:e.name}))}]});const t={},a={};e.forEach(e=>{const o=e.sector||"Unknown";t[o]||(t[o]=0,a[o]=0),t[o]+=e.value,a[o]+=1}),this.sectorData=Object.entries(t).map(([e,t])=>({name:e,value:t,count:a[e],itemStyle:{color:this.sectorColors[e]||"#6c757d"}})),this.sectorChart.setOption({series:[{data:this.sectorData}]})}generateHoldingsTable(e){const t=document.getElementById("holdings-table-container");t.innerHTML="";var a=document.createElement("table");a.id="holdings-table",a.setAttribute("data-toggle","table"),a.setAttribute("data-search","false"),a.setAttribute("data-pagination","true"),a.setAttribute("data-sortable","true"),t.appendChild(a);const o=e.reduce((e,t)=>e+t.value,0),i=Math.max(...e.map(e=>Math.abs(e.pl_percent)));e.forEach(e=>{e.portfolio_weight=e.value/o*100,e.performance_type=e.pl_percent>=0?"positive":"negative";const t=Math.abs(e.pl_percent)/i;e.progress_fill=Math.min(100,100*t)}),$("#holdings-table").bootstrapTable({data:e,pagination:!0,pageSize:20,pageList:[20,50,"all"],sortName:"pl_dollar",sortOrder:"desc",columns:[{field:"indicator",title:"",sortable:!1,width:50,align:"center",formatter:(e,t)=>this.createEmojiIndicator(t)},{field:"stock",title:"Stock",sortable:!0,width:160,formatter:(e,t)=>{const a=t.stock||"";return`<div class="stock-cell">\n              <span class="stock-symbol">${t.symbol||e||""}</span>\n              <span class="stock-name">${a}</span>\n            </div>`}},{field:"sector",title:"Sector",sortable:!0,width:105,formatter:e=>`<span class="sector-tag sector-${this.generateCSSClassName(e)}">${e}</span>`},{field:"qty",title:"Qty",sortable:!0,width:75,formatter:e=>Number(e).toFixed(3).replace(/\.?0+$/,"")},{field:"cost_price",title:"Cost ($)",titleTooltip:"Cost per share",sortable:!0,width:80,formatter:e=>e.toFixed(2)},{field:"curr_price",title:"Price ($)",sortable:!0,width:80,formatter:e=>e.toFixed(2)},{field:"cost_basis",title:"Cost Basis ($)",sortable:!0,width:110,formatter:e=>e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})},{field:"value",title:"Value ($)",sortable:!0,width:100,formatter:e=>e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})},{field:"pl_dollar",title:"P/L ($)",sortable:!0,width:100,formatter:(e,t)=>`<span class="${t.pl_class}">${e>=0?"+":""}$${e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}</span>`},{field:"pl_percent",title:"P/L (%)",sortable:!0,width:80,formatter:(e,t)=>`<span class="${t.pl_class}">${e.toFixed(2)}%</span>`},{field:"portfolio_weight",title:"Weight (%)",sortable:!0,width:80,formatter:e=>`${e.toFixed(1)}%`}]})}generateSummaryTable(e){const t=document.getElementById("summary-table-container");t.innerHTML="";const a=e.length,o=e.reduce((e,t)=>e+t.cost_basis,0),i=e.reduce((e,t)=>e+t.value,0),r=i-o,s=(i-o)/o*100,n=[...e].sort((e,t)=>t.pl_percent-e.pl_percent),c=n[0],l=n[n.length-1],d=e.filter(e=>e.pl_percent>0).length,f=e.filter(e=>e.pl_percent<0).length,h=d/a*100,m=e.reduce((e,t)=>e+t.pl_percent,0)/a,u=(e.reduce((e,t)=>{const a=t.portfolio_weight/100;return e-(a>0?a*Math.log(a):0)},0),Math.log(a),{}),b={};e.forEach(e=>{const t=e.sector||"Unknown";u[t]||(u[t]=0,b[t]=0),u[t]+=e.portfolio_weight,b[t]+=1});let p="",g=0;Object.entries(u).forEach(([e,t])=>{t>g&&(p=e,g=t)});const y=Math.max(...e.map(e=>e.portfolio_weight)),v=(e.find(e=>e.portfolio_weight===y),e.reduce((e,t)=>e+Math.pow(t.pl_percent-m,2),0)/a),C=Math.sqrt(v),$=Object.entries(u).map(([t,a])=>({sector:t,weight:a,count:b[t],avgReturn:e.filter(e=>e.sector===t).reduce((e,t)=>e+t.pl_percent,0)/b[t],totalContribution:e.filter(e=>e.sector===t).reduce((e,t)=>e+t.pl_percent*t.portfolio_weight/100,0)})).sort((e,t)=>t.weight-e.weight),w=$.reduce((e,t)=>t.avgReturn>e.avgReturn?t:e),S=$.reduce((e,t)=>t.totalContribution>e.totalContribution?t:e),F=document.createElement("div");F.className="summary-cards-container",t.appendChild(F);[{icon:"\ud83d\udcc8",iconClass:"overview-icon",title:"Total P/L",value:`${s.toFixed(2)}%`,valueClass:s>=0?"pl-positive":"pl-negative",subtext:`${r>=0?"+":""}$${r.toLocaleString()}`},{icon:"\ud83d\udcb0",iconClass:"overview-icon",title:"Portfolio Value",value:`$${i.toLocaleString()}`,subtext:`Cost: $${o.toLocaleString()}`},{icon:"\ud83d\udcca",iconClass:"win-rate-icon",title:"Average Return",value:`${m.toFixed(2)}%`,valueClass:m>=0?"pl-positive":"pl-negative",subtext:`Volatility: ${C.toFixed(1)}%`},{icon:"\ud83c\udfaf",iconClass:"win-rate-icon",title:"Win Rate",value:`${h.toFixed(1)}%`,subtext:`${d} winners, ${f} losers`},{icon:"\ud83c\udfc6",iconClass:"best-icon",title:"Best Performer",value:`+${c.pl_percent.toFixed(2)}%`,valueClass:"pl-positive",subtext:`${c.symbol} - ${c.name}`},{icon:"\ud83d\udcc9",iconClass:"worst-icon",title:"Worst Performer",value:`${l.pl_percent.toFixed(2)}%`,valueClass:"pl-negative",subtext:`${l.symbol} - ${l.name}`},{icon:"\ud83c\udfed",iconClass:"concentration-icon",title:"Top Sector",value:`${g.toFixed(1)}%`,subtext:`${p} (${b[p]} holdings)`},{icon:"\ud83d\ude80",iconClass:"best-icon",title:"Best Sector",value:`${w.avgReturn.toFixed(2)}%`,valueClass:w.avgReturn>=0?"pl-positive":"pl-negative",subtext:`${w.sector} avg return`},{icon:"\ud83d\udc8e",iconClass:"overview-icon",title:"Top Contributor",value:`${S.totalContribution.toFixed(2)}%`,valueClass:S.totalContribution>=0?"pl-positive":"pl-negative",subtext:`${S.sector} total impact`}].forEach(e=>{const t=document.createElement("div");t.className="summary-card",t.innerHTML=`\n        <div class="card-header">\n          <div class="card-icon ${e.iconClass}">${e.icon}</div>\n          <h3 class="card-title">${e.title}</h3>\n        </div>\n        <div class="card-value ${e.valueClass||""}">${e.value}</div>\n        <div class="card-subtext">${e.subtext}</div>\n      `,F.appendChild(t)})}setupEventListeners(){document.getElementById("refresh-button").addEventListener("click",()=>{this.fetchDataAndUpdate()})}async fetchDataAndUpdate(){if(this.isFetching)return;this.isFetching=!0,this.showFetchingIndicator("Fetching data, please wait...");const e=document.getElementById("refresh-button");e.disabled=!0;try{const e=window.stocksData||[];await this.fetchAllPrices(e),this.calculateStocks(e),this.generateHoldingsTable(e),this.updateChart(e),this.generateSummaryTable(e),document.getElementById("holdings-table-container").style.display="block",document.getElementById("summary-table-container").style.display="block";const t=this.getCurrentPSTTime();this.showSuccess(`Data fetched successfully at ${t} PST`)}catch(e){this.showError("Fetching error. Retrying in 1 minute..."),this.fetchRetryTimeout&&clearTimeout(this.fetchRetryTimeout),this.fetchRetryTimeout=setTimeout(()=>{this.fetchDataAndUpdate()},6e4)}finally{this.isFetching=!1,e.disabled=!1}}}new StockHoldings;