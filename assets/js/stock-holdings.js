class StockHoldings{constructor(){this.apiKey="cshj6s1r01qu99bg0oe0cshj6s1r01qu99bg0oeg",this.isFetching=!1,this.fetchRetryTimeout=null,this.chartData=[],this.myChart=null,this.init()}init(){document.addEventListener("DOMContentLoaded",()=>{this.initChart(),this.setupEventListeners(),this.fetchDataAndUpdate()})}getCurrentPSTTime(){const t=new Date,e={timeZone:"America/Los_Angeles",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1};return new Intl.DateTimeFormat("en-US",e).format(t)}showFetchingIndicator(t,e="info"){const o=document.getElementById("fetching-indicator");o.innerText=t,o.classList.remove("success","error"),"success"===e?o.classList.add("success"):"error"===e&&o.classList.add("error"),o.style.display="block"}hideFetchingIndicator(){document.getElementById("fetching-indicator").style.display="none"}showError(t){this.showFetchingIndicator(t,"error")}showSuccess(t){this.showFetchingIndicator(t,"success")}async fetchCurrentPrice(t){const e=`https://finnhub.io/api/v1/quote?symbol=${"BTC"===t.symbol?"BINANCE:BTCUSDT":t.symbol}&token=${this.apiKey}`;let o=0;const i=5,r=300;for(;o<=i;)try{const s=await fetch(e);if(429===s.status){if(++o>i)throw new Error(`Rate limit exceeded for ${t.symbol} after ${i} retries`);const e=r*Math.pow(2,o)+100*Math.random();console.log(`Rate limited for ${t.symbol}, retrying after ${e.toFixed(0)}ms (retry ${o}/${i})`),await new Promise(t=>setTimeout(t,e));continue}const n=await s.json();if(n.c)return void(t.curr_price=n.c);throw console.error(`No data for symbol: ${t.symbol}`),t.curr_price=0,new Error(`No data for symbol: ${t.symbol}`)}catch(a){if(++o>i||a.message.includes("No data for symbol"))throw console.error(`Error fetching data for ${t.symbol}:`,a),t.curr_price=0,a;const e=r*Math.pow(2,o)+100*Math.random();console.log(`Error for ${t.symbol}, retrying after ${e.toFixed(0)}ms (retry ${o}/${i})`),await new Promise(t=>setTimeout(t,e))}}async fetchAllPrices(t){const e=3;for(let o=0;o<t.length;o+=e){const i=t.slice(o,o+e).map(t=>this.fetchCurrentPrice(t));await Promise.all(i)["catch"](t=>console.error("Batch error:",t)),o+e<t.length&&await new Promise(t=>setTimeout(t,500))}}calculateStocks(t){t.forEach(t=>{t.stock=`${t.name}`,t.curr_price=parseFloat(t.curr_price.toFixed(2)),t.cost_price=parseFloat(t.cost_price.toFixed(2)),t.value=parseFloat((t.qty*t.curr_price).toFixed(2)),t.cost_basis=parseFloat((t.qty*t.cost_price).toFixed(2)),t.pl_dollar=parseFloat((t.value-t.cost_basis).toFixed(2)),t.pl_percent=parseFloat((t.pl_dollar/t.cost_basis*100).toFixed(2)),t.pl_class=t.pl_percent>=0?"pl-positive":"pl-negative"})}createEmojiIndicator(t){const e=t.performance_type,o=Math.abs(Math.round(t.pl_percent)),i="positive"===e?"+":"-",r=t.pl_percent;let a;return`<div class="emoji-indicator">\n              <div class="performance-emoji">${a="positive"===e?r>=50?"\ud83e\udd29":r>=30?"\ud83d\ude0d":r>=20?"\ud83d\ude01":r>=10?"\ud83d\ude04":r>=5?"\ud83d\ude0a":r>=1?"\ud83d\ude42":"\ud83d\ude10":r<=-50?"\ud83d\ude2d":r<=-30?"\ud83d\ude22":r<=-20?"\ud83d\ude30":r<=-10?"\ud83d\ude1e":r<=-5?"\ud83d\ude15":r<=-1?"\ud83d\ude1f":"\ud83d\ude10"}</div>\n              <div class="emoji-value emoji-value-${e}">${i}${o}%</div>\n            </div>`}initChart(){var t=document.getElementById("portfolioChart");this.myChart=echarts.init(t);var e=document.getElementById("sectorChart");this.sectorChart=echarts.init(e),this.setChartTheme(),new MutationObserver(()=>this.setChartTheme()).observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]})}setChartTheme(){const t="dark"===document.documentElement.getAttribute("data-theme");this.myChart.setOption(this.getChartOptions(t)),this.sectorChart.setOption(this.getSectorChartOptions(t))}getChartOptions(t){return{title:{text:"Portfolio Breakdown by Stock Value",left:"center",top:"5%",textStyle:{fontFamily:'"EB Garamond", serif',fontSize:18,fontWeight:"bold",color:t?"#ffffff":"#000000"}},color:["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc","#6b778d","#b5bd48","#e44a8c","#4e9caa","#8c7853","#a1488e","#5d7148","#e77c30","#4682b4","#bc8f8f","#6a5acd"],tooltip:{trigger:"item",formatter:function(t){return`${t.data.fullName}: ${t.percent}%`},textStyle:{fontFamily:'"EB Garamond", serif',color:t?"#ffffff":"#000000"},backgroundColor:t?"#333333":"#ffffff",borderColor:t?"#ffffff":"#333333"},legend:{orient:"vertical",right:"2%",top:"middle",itemGap:12,itemWidth:14,itemHeight:14,textStyle:{fontFamily:'"EB Garamond", serif',fontSize:13,color:t?"#ffffff":"#000000",padding:[0,0,0,8]},formatter:t=>{const e=this.chartData.find(e=>e.symbol===t);return e?e.name:t}},series:[{name:"Stock Value",type:"pie",radius:["40%","65%"],center:["35%","55%"],avoidLabelOverlap:!0,itemStyle:{borderRadius:10,borderColor:t?"#333333":"#ffffff",borderWidth:2},label:{show:!0,formatter:"{b}: {d}%",fontFamily:'"EB Garamond", serif',fontSize:13,position:"outside",distanceToLabelLine:20,color:t?"#ffffff":"#000000"},labelLine:{show:!0,lineStyle:{color:t?"#ffffff":"#333333"},length:25,length2:20},labelLayout:{moveOverlap:"shiftY"},emphasis:{scale:!0,scaleSize:10}}]}}getSectorChartOptions(t){return{title:{text:"Portfolio Breakdown by Sector",left:"center",top:"5%",textStyle:{fontFamily:'"EB Garamond", serif',fontSize:18,fontWeight:"bold",color:t?"#ffffff":"#000000"}},tooltip:{trigger:"item",formatter:function(t){return`${t.name}: ${t.percent}% (${t.data.count} holdings)`},textStyle:{fontFamily:'"EB Garamond", serif',color:t?"#ffffff":"#000000"},backgroundColor:t?"#333333":"#ffffff",borderColor:t?"#ffffff":"#333333"},legend:{orient:"vertical",right:"5%",top:"middle",itemGap:12,textStyle:{fontFamily:'"EB Garamond", serif',fontSize:14,color:t?"#ffffff":"#000000"}},series:[{name:"Sector Distribution",type:"pie",radius:["30%","60%"],center:["40%","55%"],avoidLabelOverlap:!0,itemStyle:{borderRadius:8,borderColor:t?"#333333":"#ffffff",borderWidth:2},label:{show:!0,formatter:"{b}: {d}%",fontFamily:'"EB Garamond", serif',fontSize:13,color:t?"#ffffff":"#000000"},emphasis:{scale:!0,scaleSize:10},data:this.sectorData||[]}]}}updateChart(t){this.chartData=t.map(t=>({name:t.name,symbol:t.symbol,value:t.value})),this.myChart.setOption({series:[{data:this.chartData.map(t=>({name:t.symbol,value:t.value,fullName:t.name}))}]});const e={},o={},i={Semiconductors:"#007bff","Internet/Cloud":"#17a2b8",Healthcare:"#28a745",Fintech:"#e83e8c","Traditional Banking":"#fd7e14",ETF:"#6f42c1"};t.forEach(t=>{const i=t.sector||"Unknown";e[i]||(e[i]=0,o[i]=0),e[i]+=t.value,o[i]+=1}),this.sectorData=Object.entries(e).map(([t,e])=>({name:t,value:e,count:o[t],itemStyle:{color:i[t]||"#6c757d"}})),this.sectorChart.setOption({series:[{data:this.sectorData}]})}generateHoldingsTable(t){const e=document.getElementById("holdings-table-container");e.innerHTML="";var o=document.createElement("table");o.id="holdings-table",o.setAttribute("data-toggle","table"),o.setAttribute("data-search","false"),o.setAttribute("data-pagination","true"),o.setAttribute("data-sortable","true"),o.setAttribute("data-sort-name","pl_percent"),o.setAttribute("data-sort-order","desc"),e.appendChild(o);const i=t.reduce((t,e)=>t+e.value,0),r=Math.max(...t.map(t=>Math.abs(t.pl_percent)));t.forEach(t=>{t.portfolio_weight=t.value/i*100,t.performance_type=t.pl_percent>=0?"positive":"negative";const e=Math.abs(t.pl_percent)/r;t.progress_fill=Math.min(100,100*e)}),$("#holdings-table").bootstrapTable({data:t,pagination:!0,pageSize:20,pageList:[20,50,100,"all"],columns:[{field:"indicator",title:"",sortable:!1,width:40,align:"center",formatter:(t,e)=>this.createEmojiIndicator(e)},{field:"stock",title:"Stock",sortable:!0},{field:"sector",title:"Sector",sortable:!0,formatter:t=>`<span class="sector-tag sector-${t.toLowerCase().replace(/[\s\/]+/g,"-")}">${t}</span>`},{field:"curr_price",title:"Price ($)",sortable:!0,formatter:t=>t.toFixed(2)},{field:"portfolio_weight",title:"Weight (%)",sortable:!0,formatter:t=>`${t.toFixed(1)}%`},{field:"pl_percent",title:"P/L (%)",sortable:!0,formatter:(t,e)=>`<span class="${e.pl_class}">${t.toFixed(2)}%</span>`}]})}generateSummaryTable(t){const e=document.getElementById("summary-table-container");e.innerHTML="";const o=t.length,i=t.reduce((t,e)=>t+e.cost_basis,0),r=t.reduce((t,e)=>t+e.value,0),a=r-i,s=(r-i)/i*100,n=[...t].sort((t,e)=>e.pl_percent-t.pl_percent),l=n[0],c=n[n.length-1],d=t.filter(t=>t.pl_percent>0).length,f=t.filter(t=>t.pl_percent<0).length,h=d/o*100,m=t.reduce((t,e)=>t+e.pl_percent,0)/o,u=(t.reduce((t,e)=>{const o=e.portfolio_weight/100;return t-(o>0?o*Math.log(o):0)},0),Math.log(o),{}),p={};t.forEach(t=>{const e=t.sector||"Unknown";u[e]||(u[e]=0,p[e]=0),u[e]+=t.portfolio_weight,p[e]+=1});let g="",b=0;Object.entries(u).forEach(([t,e])=>{e>b&&(g=t,b=e)});const v=Math.max(...t.map(t=>t.portfolio_weight)),y=(t.find(t=>t.portfolio_weight===v),t.reduce((t,e)=>t+Math.pow(e.pl_percent-m,2),0)/o),$=Math.sqrt(y),C=Object.entries(u).map(([e,o])=>({sector:e,weight:o,count:p[e],avgReturn:t.filter(t=>t.sector===e).reduce((t,e)=>t+e.pl_percent,0)/p[e],totalContribution:t.filter(t=>t.sector===e).reduce((t,e)=>t+e.pl_percent*e.portfolio_weight/100,0)})).sort((t,e)=>e.weight-t.weight),w=C.reduce((t,e)=>e.avgReturn>t.avgReturn?e:t),F=C.reduce((t,e)=>e.totalContribution>t.totalContribution?e:t),_=document.createElement("div");_.className="summary-cards-container",e.appendChild(_),[{icon:"\ud83d\udcc8",iconClass:"overview-icon",title:"Total P/L",value:`${s.toFixed(2)}%`,valueClass:s>=0?"pl-positive":"pl-negative",subtext:`${a>=0?"+":""}$${a.toLocaleString()}`},{icon:"\ud83d\udcb0",iconClass:"overview-icon",title:"Portfolio Value",value:`$${r.toLocaleString()}`,subtext:`Cost: $${i.toLocaleString()}`},{icon:"\ud83d\udcca",iconClass:"win-rate-icon",title:"Average Return",value:`${m.toFixed(2)}%`,valueClass:m>=0?"pl-positive":"pl-negative",subtext:`Volatility: ${$.toFixed(1)}%`},{icon:"\ud83c\udfaf",iconClass:"win-rate-icon",title:"Win Rate",value:`${h.toFixed(1)}%`,subtext:`${d} winners, ${f} losers`},{icon:"\ud83c\udfc6",iconClass:"best-icon",title:"Best Performer",value:`+${l.pl_percent.toFixed(2)}%`,valueClass:"pl-positive",subtext:`${l.symbol} - ${l.name}`},{icon:"\ud83d\udcc9",iconClass:"worst-icon",title:"Worst Performer",value:`${c.pl_percent.toFixed(2)}%`,valueClass:"pl-negative",subtext:`${c.symbol} - ${c.name}`},{icon:"\ud83c\udfed",iconClass:"concentration-icon",title:"Top Sector",value:`${b.toFixed(1)}%`,subtext:`${g} (${p[g]} holdings)`},{icon:"\ud83d\ude80",iconClass:"best-icon",title:"Best Sector",value:`${w.avgReturn.toFixed(2)}%`,valueClass:w.avgReturn>=0?"pl-positive":"pl-negative",subtext:`${w.sector} avg return`},{icon:"\ud83d\udc8e",iconClass:"overview-icon",title:"Top Contributor",value:`${F.totalContribution.toFixed(2)}%`,valueClass:F.totalContribution>=0?"pl-positive":"pl-negative",subtext:`${F.sector} total impact`}].forEach(t=>{const e=document.createElement("div");e.className="summary-card",e.innerHTML=`\n        <div class="card-header">\n          <div class="card-icon ${t.iconClass}">${t.icon}</div>\n          <h3 class="card-title">${t.title}</h3>\n        </div>\n        <div class="card-value ${t.valueClass||""}">${t.value}</div>\n        <div class="card-subtext">${t.subtext}</div>\n      `,_.appendChild(e)})}setupEventListeners(){document.getElementById("refresh-button").addEventListener("click",()=>{this.fetchDataAndUpdate()})}async fetchDataAndUpdate(){if(this.isFetching)return;this.isFetching=!0,this.showFetchingIndicator("Fetching data, please wait...");const t=document.getElementById("refresh-button");t.disabled=!0;try{const o=window.stocksData||[];await this.fetchAllPrices(o),this.calculateStocks(o),this.generateHoldingsTable(o),this.updateChart(o),this.generateSummaryTable(o),document.getElementById("holdings-table-container").style.display="block",document.getElementById("summary-table-container").style.display="block";const i=this.getCurrentPSTTime();this.showSuccess(`Data fetched successfully at ${i} PST`)}catch(e){this.showError("Fetching error. Retrying in 1 minute..."),this.fetchRetryTimeout&&clearTimeout(this.fetchRetryTimeout),this.fetchRetryTimeout=setTimeout(()=>{this.fetchDataAndUpdate()},6e4)}finally{this.isFetching=!1,t.disabled=!1}}}new StockHoldings;